# Solarseed TOU Plugin — YAML Contract Specification

> **Purpose:** This document defines the complete YAML configuration format that the Solarseed Rate Calculator exports and the Solarseed TOU Home Assistant plugin must consume. An agent working on either the calculator or the plugin can use this as the authoritative interface contract.
>
> **Source of truth:** The calculator's `yaml-generator.ts` produces the YAML. The plugin's config flow and schedule resolver must parse it.
>
> **Repositories:**
> - Calculator: `solarseed` (website) — `src/components/RateCalculator/`
> - Plugin: `solarseed-tou-metering` (HACS integration) — `custom_components/solarseed_tou/`

---

## Design Philosophy: Minimal Data, Maximum Transparency

The YAML exports **summed formula values** that the plugin uses directly, with **human-readable comments** showing every constituent bill line item. This gives the plugin the minimum data it needs to compute rates, while letting users see exactly how each sum was derived.

- **Minimal:** The plugin reads a single summed value per category — no arrays to iterate.
- **Transparent:** Every bill line item is listed as a comment so users can verify correctness.
- **Portable:** A user can fill in the YAML by hand using their bill — no website required.
- **Auditable:** The comment breakdowns can be checked against the original utility bill.

The calculator does the hard work of decomposing a utility bill into formula components and summing them. The YAML preserves both the sum (data) and the breakdown (comments).

---

## The Formula

The effective $/kWh rate for any tier is computed by the plugin at runtime:

```
effective_rate = (
    tier_rate                   # summed usage + transmission + distribution + PCA
  + regulatory_per_kwh          # summed flat per-kWh regulatory surcharges
  + state_passthrough_per_kwh   # summed state-mandated per-kWh items
  + programs_per_kwh            # summed enrolled programs (rate × fraction each)
) × (1 + tax_rate_pct / 100)   # summed percentage-based taxes
```

The **tier rate** varies per tier (that's what makes TOU work — different rates at different times). Everything else (regulatory, programs, taxes) is **shared across all tiers** and applied equally.

---

## Complete YAML Structure

```yaml
# Solarseed TOU Energy Metering
# https://github.com/danrichardson/solarseed-tou-metering
# Rate plan: PGE Schedule 7 (Oregon Residential TOU)
# Utility: Portland General Electric
# Generated by Johnny Solarseed Rate Calculator
# Validated: Jan 2026, $68.15 (variance: $0.14, 0.21%)
#
# Formula: effective = (tier_rate + regulatory + passthrough + programs) × (1 + tax / 100)

tou_metering:
  energy_sensor: "sensor.YOUR_ENERGY_SENSOR"

  # ── Per-tier rate (summed from bill components) ──
  tiers:
    off-peak:
      name: "Off-Peak"
      color: "#22c55e"
      # Tier rate components (from your bill):
      #   Usage:        $0.04956/kWh
      #   Transmission: $0.01187/kWh
      #   Distribution: $0.02153/kWh
      #   PCA:          $0.00043/kWh
      rate: 0.08339
      # effective: $0.1138/kWh (after adders + tax)
    mid-peak:
      name: "Mid-Peak"
      color: "#f59e0b"
      # Tier rate components (from your bill):
      #   Usage:        $0.06281/kWh
      #   Transmission: $0.01187/kWh
      #   Distribution: $0.02153/kWh
      #   PCA:          $0.00043/kWh
      rate: 0.09664
      # effective: $0.1954/kWh (after adders + tax)
    on-peak:
      name: "On-Peak"
      color: "#ef4444"
      # Tier rate components (from your bill):
      #   Usage:        $0.12345/kWh
      #   Transmission: $0.01187/kWh
      #   Distribution: $0.02153/kWh
      #   PCA:          $0.00043/kWh
      rate: 0.15728
      # effective: $0.4729/kWh (after adders + tax)

  # ── Shared per-kWh adders (summed, apply to all tiers equally) ──

  # Regulatory charges (per kWh, from your bill):
  #   Renewable Energy Rider: $0.00152/kWh
  #   Energy Efficiency:      $0.00089/kWh
  regulatory_per_kwh: 0.00241

  # State pass-through charges (per kWh, from your bill):
  #   Public Purpose Charge:        $0.00573/kWh
  #   Residential Exchange Credit: -$0.00089/kWh
  state_passthrough_per_kwh: 0.00484

  # Voluntary programs (per kWh, adjusted for participation):
  #   Green Future Choice: $0.00500 × 73.0% = $0.00365/kWh
  programs_per_kwh: 0.00365

  # Tax rates (percentage of volumetric charges):
  #   City Utility Tax: 1.500%
  #   County Tax:       0.500%
  tax_rate_pct: 2.000

  # Fixed monthly charges:
  #   Basic Charge:        $11.00
  #   Schedule Adjustment: $0.28
  #   Subtotal: $11.28 × (1 + 2.000%) = $11.51
  fixed_monthly: 11.51

  # Computed effective rates:
  #   Off-Peak: $0.1138/kWh
  #   Mid-Peak: $0.1954/kWh
  #   On-Peak:  $0.4729/kWh

  # ── Schedule + Holidays ──
  seasons:
    all_year:
      name: "All Year"
      months: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
      grid:
        mon: ["off-peak", "off-peak", ..., "off-peak"]  # 24 entries
        tue: [...]
        wed: [...]
        thu: [...]
        fri: [...]
        sat: [...]
        sun: [...]

  holidays:
    rate_tier: "off-peak"
    observe_nearest_weekday: true
    standard:
      - "new_years"
      - "memorial"
      - "independence"
      - "labor"
      - "thanksgiving"
      - "christmas"
```

---

## Section-by-Section Reference

### 1. Root Key: `tou_metering`

All configuration lives under `tou_metering:`. This is the top-level key.

### 2. `energy_sensor` (string, required)

```yaml
energy_sensor: "sensor.YOUR_ENERGY_SENSOR"
```

- The Home Assistant entity ID for the energy sensor to track
- The calculator exports a placeholder: `sensor.YOUR_ENERGY_SENSOR`
- The user replaces this with their actual sensor entity ID in HA

### 3. `tiers` (dict, required)

Each key is a **tier ID**, each value contains display metadata and a summed per-kWh rate. The individual bill components that make up the rate are listed as comments.

```yaml
tiers:
  off-peak:
    name: "Off-Peak"
    color: "#22c55e"
    # Tier rate components (from your bill):
    #   Usage:        $0.04956/kWh
    #   Transmission: $0.01187/kWh
    #   Distribution: $0.02153/kWh
    #   PCA:          $0.00043/kWh
    rate: 0.08339
    # effective: $0.1138/kWh (after adders + tax)
```

#### Tier fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Human-readable display name. Quoted. |
| `color` | string | Yes | Hex color for UI display. Quoted. |
| `rate` | float | Yes | Summed tier rate per kWh (usage + transmission + distribution + PCA). 5 decimal places. |

The comment block shows the 4 individual bill components that were summed to produce `rate`. The `# effective` comment shows the final rate after adders and tax — the plugin computes this at runtime.

#### Tier ID rules

- **Format:** kebab-case lowercase (`off-peak`, `mid-peak`, `on-peak`, `flat`)
- The ID is used as the dictionary key AND referenced in schedule grids and holiday config
- Common IDs: `off-peak`, `mid-peak`, `on-peak`, `flat`

#### What varies per tier vs. what's shared

| Per-tier (`rate`) | Shared (separate fields) |
|-------------------|--------------------------|
| Sum of usage, transmission, distribution, PCA — different rates for different times | `regulatory_per_kwh` — same for all tiers |
| | `state_passthrough_per_kwh` — same for all tiers |
| | `programs_per_kwh` — same for all tiers |
| | `tax_rate_pct` — same for all tiers |

In practice, only `usage` typically differs across tiers, but the format sums all four components per tier to support utility structures where transmission/distribution/PCA also vary.

### 4. `regulatory_per_kwh` (float, optional)

Summed flat per-kWh regulatory surcharges that apply equally to all tiers. Individual items are listed as comments.

```yaml
  # Regulatory charges (per kWh, from your bill):
  #   Renewable Energy Rider: $0.00152/kWh
  #   Energy Efficiency:      $0.00089/kWh
  regulatory_per_kwh: 0.00241
```

| Field | Type | Description |
|-------|------|-------------|
| `regulatory_per_kwh` | float | Sum of all regulatory per-kWh charges. 5 decimal places. May be negative if credits exceed charges. |

Omitted entirely if there are no regulatory items.

### 5. `state_passthrough_per_kwh` (float, optional)

Summed state-mandated per-kWh pass-through charges. Same concept as regulatory but from a different section of the bill. Individual items listed as comments.

```yaml
  # State pass-through charges (per kWh, from your bill):
  #   Public Purpose Charge:        $0.00573/kWh
  #   Residential Exchange Credit: -$0.00089/kWh
  state_passthrough_per_kwh: 0.00484
```

### 6. `programs_per_kwh` (float, optional)

Summed per-kWh contribution from enrolled utility programs. Each program's rate is adjusted by its kWh fraction before summing. Comments show the per-program calculation.

```yaml
  # Voluntary programs (per kWh, adjusted for participation):
  #   Green Future Choice: $0.00500 × 73.0% = $0.00365/kWh
  programs_per_kwh: 0.00365
```

| Field | Type | Description |
|-------|------|-------------|
| `programs_per_kwh` | float | Sum of `rate × kwh_fraction` for all enabled programs. 5 decimal places. |

For programs that apply to 100% of usage, the comment shows just the rate without the fraction calculation. Only enabled programs are included.

### 7. `tax_rate_pct` (float, optional)

Sum of all percentage-based taxes applied to the volumetric subtotal. Individual taxes listed as comments.

```yaml
  # Tax rates (percentage of volumetric charges):
  #   City Utility Tax: 1.500%
  #   County Tax:       0.500%
  tax_rate_pct: 2.000
```

| Field | Type | Description |
|-------|------|-------------|
| `tax_rate_pct` | float | Sum of all tax percentages (2.0 = 2.0%). 3 decimal places. |

Applied as a multiplier: `(1 + tax_rate_pct / 100)`. For example, 2.0% → multiplier of `1.02`.

### 8. `fixed_monthly` (float, optional)

Total fixed monthly charges (after tax). Not part of the per-kWh formula — a separate monthly cost. Individual charges and the tax calculation are listed as comments.

```yaml
  # Fixed monthly charges:
  #   Basic Charge:        $11.00
  #   Schedule Adjustment: $0.28
  #   Subtotal: $11.28 × (1 + 2.000%) = $11.51
  fixed_monthly: 11.51
```

| Field | Type | Description |
|-------|------|-------------|
| `fixed_monthly` | float | Total monthly fixed charges after tax. 2 decimal places. |

The subtotal comment shows the pre-tax sum and the tax calculation. If there is no tax, the subtotal line is omitted.

### 9. `seasons` (dict, required for schedule)

Defines seasonal rate schedule variations. Each season has a name, months, and a 7×24 schedule grid.

```yaml
seasons:
  all_year:
    name: "All Year"
    months: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
    grid:
      mon: ["off-peak", ...]  # 24 tier IDs
      ...
```

#### Season fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Human-readable name. |
| `months` | int[] | Yes | 1-based month numbers. |
| `grid` | dict | Yes | 7-day × 24-hour schedule grid. |
| `color` | string | No | Optional hex color. |

#### Schedule Grid

- **7 day keys:** `mon`, `tue`, `wed`, `thu`, `fri`, `sat`, `sun`
- **Each day:** exactly **24 string entries** (index 0 = midnight, index 23 = 11 PM)
- **Each entry:** a tier ID that MUST match a key in `tiers`

#### Month assignments

- Every month (1–12) MUST appear in exactly one season
- No gaps, no overlaps

### 10. `holidays` (dict, optional)

Days that override the normal schedule and use a single tier all day.

```yaml
holidays:
  rate_tier: "off-peak"
  observe_nearest_weekday: true
  standard:
    - "new_years"
    - "memorial"
    - "independence"
    - "labor"
    - "thanksgiving"
    - "christmas"
  custom:
    - name: "Company Holiday"
      rule: "fixed"
      month: 3
      day: 15
```

#### Standard Holiday IDs

| ID | Holiday | Rule |
|----|---------|------|
| `new_years` | New Year's Day | Fixed: January 1 |
| `mlk` | MLK Day | 3rd Monday of January |
| `presidents` | Presidents' Day | 3rd Monday of February |
| `memorial` | Memorial Day | Last Monday of May |
| `juneteenth` | Juneteenth | Fixed: June 19 |
| `independence` | Independence Day | Fixed: July 4 |
| `labor` | Labor Day | 1st Monday of September |
| `columbus` | Columbus Day | 2nd Monday of October |
| `veterans` | Veterans Day | Fixed: November 11 |
| `thanksgiving` | Thanksgiving | 4th Thursday of November |
| `christmas` | Christmas Day | Fixed: December 25 |

#### Holiday Rules

Three rule types: `fixed` (month + day), `nth` (nth weekday of month), `last` (last weekday of month).

Weekday numbering uses **Python convention**: `0`=Mon, `1`=Tue, ..., `6`=Sun.

When `observe_nearest_weekday` is true, Saturday holidays shift to Friday, Sunday holidays shift to Monday.

---

## Plugin Resolution Algorithm

```
function resolveEffectiveRate(config, now):
  1. Resolve tier ID (schedule + holidays):
     a. Check if today is a holiday → use holidays.rate_tier
     b. Find season for current month
     c. Look up grid[day_of_week][hour] → tier_id

  2. Compute rate from formula:
     tier = config.tiers[tier_id]

     effective_rate = (
         tier.rate
       + config.regulatory_per_kwh        # default 0 if absent
       + config.state_passthrough_per_kwh  # default 0 if absent
       + config.programs_per_kwh           # default 0 if absent
     ) × (1 + config.tax_rate_pct / 100)   # default 0 if absent

  3. return effective_rate
```

**Priority order:** Holiday tier overrides season/grid. Season grids are resolved by month. Hour index is the final step.

---

## Edge Cases

### 1. Single-tier (flat rate)
Grid cells all contain the same tier ID. The formula still applies — just one rate value.

### 2. Missing formula fields
Any of `regulatory_per_kwh`, `state_passthrough_per_kwh`, `programs_per_kwh`, `tax_rate_pct`, `fixed_monthly` may be absent. Treat as 0.

### 3. Negative values
Credits (like Residential Exchange Credit) may cause `state_passthrough_per_kwh` or `regulatory_per_kwh` to be negative. The formula handles this naturally.

### 4. No holidays section
Skip holiday check — go straight to season/grid resolution.

### 5. No seasons
The plugin should prompt for schedule configuration.

### 6. Month not in any season
Fall back to the first defined season.

---

## Testing Checklist for Plugin Compliance

- [ ] Parses `tou_metering:` as root key
- [ ] Reads `energy_sensor` for power consumption tracking
- [ ] Parses all tiers with `name`, `color`, and `rate`
- [ ] Reads `regulatory_per_kwh` as a scalar (default 0 if absent)
- [ ] Reads `state_passthrough_per_kwh` as a scalar (default 0 if absent)
- [ ] Reads `programs_per_kwh` as a scalar (default 0 if absent)
- [ ] Reads `tax_rate_pct` as a scalar (default 0 if absent)
- [ ] Reads `fixed_monthly` as a scalar (default 0 if absent)
- [ ] Computes effective rate: `(tier.rate + reg + passthrough + programs) × (1 + tax / 100)`
- [ ] Handles negative per-kWh values (credits) correctly
- [ ] Handles missing formula fields (treats as 0)
- [ ] Uses tier keys for schedule grid lookups
- [ ] Reads seasons as a dict with `months` and `grid`
- [ ] Grid: 7 day keys, 24 tier IDs per day
- [ ] Hour index 0 = midnight, 23 = 11 PM
- [ ] Resolves holidays before season grid
- [ ] Implements all 11 standard holiday IDs
- [ ] Implements `fixed`, `nth`, `last` holiday rules
- [ ] Weekday convention: 0=Mon, 6=Sun
- [ ] Applies `observe_nearest_weekday` shifting
- [ ] Falls back to first season for unknown months
- [ ] Ignores comment lines (lines starting with `#`)

---

**YAML format:** Standard YAML 1.2, no custom tags, no anchors/aliases.
